##############
### Github ###
##############

EMAIL="62436169+sorrtory@users.noreply.github.com"
NAME="sorrtory"
# That's why `get_secrets.sh` must be called first to get the ssh key for GitHub
GITHUB="git@github.com:$NAME"
GITHUB_KEY="$HOME/Documents/secrets/.ssh/id_ed25519_github"

# Repositories to clone inside Documents from $GITHUB
REPOS_TO_CLONE=(
	"Knowledge-Database"
)

#############
### Links ###
#############

# The `link.sh` script will be executed on these two
LINK_TO_SSH="--home Documents/secrets/.ssh"

LINKS=(
	# Configs
    "--home Documents/configs/.zshrc"
    "--home Documents/configs/.vimrc"
	"$HOME/Documents/configs/.obsidian $HOME/Documents/Knowledge-Database/.obsidian"
	"$HOME/Documents/configs/mpv/"
	# Secrets
	# "--sudo Documents/secrets/wireguard /etc/wireguard" # doesn't work, we have to copy :(
	# Scripts
	"--sudo --bin Documents/scripts/lofi.sh"
	"--sudo --bin Documents/scripts/sharekey.sh"
	"--sudo --bin Documents/scripts/cutname.sh"
	"--sudo --bin Documents/scripts/commit_info.sh"
	"--sudo --bin Documents/scripts/vpn.sh"
	"--sudo --bin Documents/scripts/link.sh"
)

######################
### External proxy ###
######################

VPN_PROFILES_FOLDER="$HOME/Documents/secrets/wireguard/"
VPN_DEFAULT_PROFILE="laptop"					  
VPN_CONTAINER_NAME="ssProxy"  # lxd proxy container name for WireGuard
VPN_CONTAINER_IP_HOST="254"   # This is the the last 8 bytes of EXTERNAL_PROXY_IP

# Setup shadowsocks http and socks5 proxies withoud encryption (method=none)

# EXTERNAL_PROXY_IP will be substituted dynamically with regard of $VPN_CONTAINER_NAME's ip
SSSERVER_CONF='{
"server": "EXTERNAL_PROXY_IP",
"server_port": 8388,
"method": "none",
"mode":"tcp_and_udp"
}'

# EXTERNAL_PROXY_IP will be substituted dynamically with regard of $VPN_CONTAINER_NAME's ip
SSLOCAL_CONF='
{
"server": "EXTERNAL_PROXY_IP",
"server_port": 8388,
"method": "none",
"mode": "tcp_and_udp",
"locals": [
	{
		"local_address": "127.0.0.1",
		"local_port": 1080
	},
	{
		"local_address": "127.0.0.1",
		"local_port": 3128,
		"protocol": "http"
	}
  ]
}'

#####################
### VPN Namespace ###
#####################

VPN_NAMESPACE_NAME="vpn"
VPN_NAMESPACE_PROFILE="extra"

###############
### Firefox ###
###############

# EXTERNAL_PROXY_IP will be substituted dynamically with regard of $VPN_CONTAINER_NAME's ip
# But we don't need it
FIREFOX_PREFERENCES='
user_pref("network.proxy.type", 1);
user_pref("network.proxy.http", "127.0.0.1");
user_pref("network.proxy.http_port", 3128);
user_pref("network.proxy.ssl", "127.0.0.1");
user_pref("network.proxy.ssl_port", 3128);
user_pref("browser.tabs.insertAfterCurrent", true);
user_pref("browser.ctrlTab.sortByRecentlyUsed", true);
user_pref("network.proxy.socks_remote_dns", true);
user_pref("network.proxy.socks", "127.0.0.1");
user_pref("network.proxy.socks_port", "1080");
'

#############
### Gnome ###
#############

# List of initial gsettings commands for Gnome customization
GSETTINGS_CMDS=(
	### Gnome General ###

	# Center new windows
	"gsettings set org.gnome.mutter center-new-windows true"

	# Set keyboard layout and input sources
	"gsettings set org.gnome.desktop.input-sources sources \"[('xkb', 'us'), ('xkb', 'ru')]\""
	"gsettings set org.gnome.desktop.input-sources xkb-options \"['grp:alt_shift_toggle']\""

	# Disable Gnome Desktop
	"gnome-extensions disable ding@rastersoft.com"

	### Gnome color theme ###
	# "gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark'"
	# Adwaita doesn't support accent-color fully. Use Yaru theme
	
	# Also you can set gtk-application-prefer-dark-theme=1 in ~/.config/gtk-4.0/settings.ini
	# https://askubuntu.com/questions/769417/how-to-change-global-dark-theme-on-and-off-through-terminal
	# "gsettings set org.gnome.desktop.interface accent-color 'orange'" # Doesn't work on Ubuntu 24.04.3 LTS
	# "gsettings set org.gnome.desktop.interface icon-theme 'Yaru-red-dark'"
	# "gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'"

	### Gnome Keybindings ###

	# Disable default win+n binding (to add custom keybinding)
	"gsettings set org.gnome.shell.keybindings focus-active-notification  '[\"disabled\"]'"
	# Disable default win+s binding (to add custom keybinding)
	"gsettings set org.gnome.shell.keybindings toggle-quick-settings '[\"disabled\"]'"

	# Move window left/right
	"gsettings set org.gnome.desktop.wm.keybindings move-to-workspace-left \"['<Control><Super>Left']\""
	"gsettings set org.gnome.desktop.wm.keybindings move-to-workspace-right \"['<Control><Super>Right']\""

	# Switch workspace left/right
	"gsettings set org.gnome.desktop.wm.keybindings switch-to-workspace-left \"['<Control><Alt>Left']\""
	"gsettings set org.gnome.desktop.wm.keybindings switch-to-workspace-right \"['<Control><Alt>Right']\""

	# Close window
	"gsettings set org.gnome.desktop.wm.keybindings close \"['<Super>q']\""

	### Ubuntu dock panel ###
	# Set dock position
	# "gsettings set org.gnome.shell.extensions.dash-to-dock dock-position 'BOTTOM'"
	"gsettings set org.gnome.shell.extensions.dash-to-dock always-center-icons true"
	"gsettings set org.gnome.shell.extensions.dash-to-dock show-show-apps-button false"
	"gsettings set org.gnome.shell.extensions.dash-to-dock show-trash false"


	# Set dock Behaviour
	"gsettings set org.gnome.shell.extensions.dash-to-dock click-action 'minimize'"
	# Disable super+1.2.3... for dock launchers
	# https://askubuntu.com/questions/968103/disable-the-default-app-key-supernum-functionality-on-ubuntu-17-10-and-later
	# Switch to app looks useful. Let's try to keep it (the command bellow disables it)
	# gsettings set org.gnome.shell.keybindings switch-to-application-1 [] # Repeat for 1-9
	"gsettings set org.gnome.shell.extensions.dash-to-dock hot-keys false"

	# # ? This is controversial Transparent+Autohide
	"gsettings set org.gnome.shell.extensions.dash-to-dock autohide true"
	"gsettings set org.gnome.shell.extensions.dash-to-dock intellihide true"
	"gsettings set org.gnome.shell.extensions.dash-to-dock dock-fixed false"
	"gsettings set org.gnome.shell.extensions.dash-to-dock intellihide-mode 'ALL_WINDOWS'"
	"gsettings set org.gnome.shell.extensions.dash-to-dock extend-height true"

	# # Set dock Transparency
	# "gsettings set org.gnome.shell.extensions.dash-to-dock transparency-mode 'DYNAMIC'"
	# "gsettings set org.gnome.shell.extensions.dash-to-dock customize-alphas true"
	# "gsettings set org.gnome.shell.extensions.dash-to-dock min-alpha 0.0"
	# "gsettings set org.gnome.shell.extensions.dash-to-dock max-alpha 0.8"

	# * This is more tidy panel setup
	# "gsettings set org.gnome.shell.extensions.dash-to-dock extend-height false"
	# "gsettings set org.gnome.shell.extensions.dash-to-dock dock-fixed false"


)

#########################
### Gnome keybindings ###
#########################

# This is a list of custom hotkeys
# * If the shortcut is already used the script will append them anyway.
# * However, it won't have any effect.
# If there it overlaps with system default, you have to disable using gsettings
# 1. Find an overlapping keybinding using GUI gnome settings (manually)
# 2. Find a dconf name with - gsettings list-keys org.gnome.shell.keybindings, etc. (there are many)
# 3. Disable with - gsettings set org.gnome.shell.keybindings screenshot '["disabled"]'
# example: win+s : gsettings set org.gnome.shell.keybindings toggle-quick-settings '["disabled"]'


# [<Name>]="<Command to launch>"|"<Keybinding>"
declare -A CUSTOM_LAUNCHERS=(
	[firefox]="firefox|<Super>f"
	[code]="code|<Super>c"
	[typing]="subl|<Super>t"
	[obsidian]="obsidian|<Super>n"
	[explorer]="nautilus -w|<Super>e"
	[gradia]="flatpak run be.alexandervanhee.gradia --screenshot=INTERACTIVE|<Shift>F11"
	[spotify]="spotify|<Super>s"
)

########################
### Gnome extensions ###
########################
# The `gnome-shell-extension-installer` script is archived and acts strange.
# But it seems to work after rebooting and manually reinstalling blur-my-shell

# My extensions:
# blur my shell, clipboard indicator, hide top bar, 
# ubuntu appindicator, ubuntu dock, ubuntu tiling assistant are default

# <extension_name> - Check in extension manager
# <extension_id>   - Check on https://extensions.gnome.org/
# [<extension_name>]="<extension_id>"
declare -A ADD_EXTENSIONS=(	
	[blur-my-shell@aunetx]="3193" 			# Blur my shell
	[clipboard-indicator@tudmotu.com]="779" # Clipboard Indicator
	[hidetopbar@mathieu.bidon.ca]="545"     # Hide Top Bar
)


################
### Commands ###
################

# ? May it be unnecessary untill you use conf for Arch
INSTALL_CMD="sudo apt install -y"
UPDATE_CMD="sudo apt update -y"
ADD_REPO_CMD="sudo add-apt-repository -y"

################
### Packages ###
################


# Package repositories that are added before installing packages with $ADD_REPO_CMD
# Would be added on --pkgs
PKG_REPOS=(
)

# Platform native packages installing with $INSTALL_CMD
# Would be installed on --pkgs
PKGS=(
	# Base packages
	"git"
	"curl"
	"wget"
	"gpg"
	"mpv"
	"vim"
	"firefox"
	"imagemagick"
	"transmission"
	"audacity"
	"libreoffice"
    "tree"
    "wl-clipboard"
	# Additional tools
	"wireguard-tools"
	"zsh"
	"fzf"
	"htop"
	"bat"
	"screen"
	"tmux"
	"httpie"
    "obs-studio"
    "libimage-exiftool-perl"
    "ripgrep"
    "fd-find"
	# Dependencies
	"pipx"
	"gcc"
	"make"
	"g++"
	"software-properties-common"
	"apt-transport-https"
	"default-jre"
	"default-jdk"
	"gnome-tweaks"
	"gnome-shell-extension-manager"
	"dconf-editor"
)

#############
### Snaps ###
#############

# `snap install` acts strange, can't pass --<arg> directly
# Need a dict to work with few args
# Would be installed on --snaps
declare -A SNAP_PKGS=(
	[lxd]=""
	[obsidian]="--classic"
	[yazi]="--classic"
)

################
### Flatpaks ###
################

FLATPAK_PKGS=(
	"be.alexandervanhee.gradia"
)

########################
### Special Packages ###
########################

# This is the list of programs that can't be installed easily with $INSTALL_CMD
# Dict: <cmd_to_check>:<install_function>
# 
declare -A SPECIAL_PKGS=(
	["go"]="install_golang"
	["docker"]="install_docker"
	["google-chrome"]="install_chrome"
	["code"]="install_code"
	["subl"]="install_sublime"
	["smerge"]=""             			# Installs with sublime text
	["spotify"]="install_spotify"
    ["yt-dlp"]="install_ytdlp"
    ["tldr"]="install_tldr"
    ["rustc"]="install_rust"
    ["zsh"]="install_zsh"
    ["nvm"]="install_nvm"
)

# You are free to add more install_<name> functions here, just `export -f` them
#

# -- yt-dlp
function install_ytdlp() {
    # https://github.com/yt-dlp/yt-dlp/wiki/Installation
	wget https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -O ~/.local/bin/yt-dlp
	chmod a+rx ~/.local/bin/yt-dlp  # Make executable
}
export -f install_ytdlp


# -- tldr
function install_tldr() {
	pipx install tldr
}
export -f install_tldr


# -- rust
function install_rust() {
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
}
export -f install_rust


# -- zsh
function install_zsh() {
    # current .zshrc will be ignored
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

    ## -- zsh-autosuggestions
    git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions

    ## -- zsh-syntax-highlighting
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting

    ## -- zsh-lazyload
    git clone https://github.com/qoomon/zsh-lazyload $ZSH_CUSTOM/plugins/zsh-lazyload
}
export -f install_zsh


# -- nvm
function install_nvm() {
    # bump the version here
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.4/install.sh | bash

    # install latest node
    nvm install node

    # pnpm
    curl -fsSL https://get.pnpm.io/install.sh | sh -
}
export -f install_nvm


function install_golang() {
	info_start "Installing Go"
	# Download latest Go
	GO_VERSION=$(curl -s "https://go.dev/VERSION?m=text" | head -n 1)
	GO_TAR="${GO_VERSION}.linux-amd64.tar.gz"
	wget "https://dl.google.com/go/${GO_TAR}"
	sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf "${GO_TAR}"
	rm "${GO_TAR}"

	# Add Go to PATH
	echo "Adding Go to PATH"
	GO_PATH="/usr/local/go/bin"
	ENV_FILE="/etc/environment"
	if [[ ! -f "$ENV_FILE" ]]; then
		echo "ERROR: $ENV_FILE does not exist" >&2
		exit 1
	fi
	sudo cp "$ENV_FILE" "$ENV_FILE.bak.$(date +%F_%T)"
	echo "Backup created: $ENV_FILE.bak.$(date +%F_%T)"
	CURRENT_PATH=$(grep -E '^PATH=' "$ENV_FILE" | cut -d= -f2- | tr -d '"')
	if [[ -z "$CURRENT_PATH" ]]; then
		echo "PATH=\"$GO_PATH\"" | sudo tee -a "$ENV_FILE" >/dev/null
		echo "Added new PATH with Go bin"
		info_end "Go installed and PATH updated"
		return
	fi
	if [[ ":$CURRENT_PATH:" == *":$GO_PATH:"* ]]; then
		echo "Go path already in PATH, nothing to do."
		info_end "Go installed and PATH updated"
		return
	fi
	NEW_PATH="$CURRENT_PATH:$GO_PATH"
	sudo sed -i "s|^PATH=.*|PATH=\"$NEW_PATH\"|" "$ENV_FILE"
	info_end "Go installed and PATH updated"
}
export -f install_golang

function install_sublime() {
	# Install sublime text
	info_start "Installing Sublime Text"
	wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | sudo tee /etc/apt/keyrings/sublimehq-pub.asc > /dev/null
	echo -e 'Types: deb\nURIs: https://download.sublimetext.com/\nSuites: apt/stable/\nSigned-By: /etc/apt/keyrings/sublimehq-pub.asc' | sudo tee /etc/apt/sources.list.d/sublime-text.sources
	$UPDATE_CMD
	$INSTALL_CMD apt-transport-https
	
	$INSTALL_CMD sublime-text
	info_end "Sublime Text installed"

	# Install Sublime Merge
	info_start "Installing Sublime Merge"
	$INSTALL_CMD sublime-merge
	info_end "Sublime Merge installed"
}
export -f install_sublime

function install_chrome() {
	info_start "Installing Google Chrome"
	wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/google.gpg
	echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
	$UPDATE_CMD

	$INSTALL_CMD google-chrome-stable
	info_end "Google Chrome installed"
}
export -f install_chrome


function install_code() {
	info_start "Installing Visual Studio Code"

	wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
	sudo install -D -o root -g root -m 644 microsoft.gpg /usr/share/keyrings/microsoft.gpg
	rm -f microsoft.gpg
	printf "Types: deb\nURIs: https://packages.microsoft.com/repos/code\nSuites: stable\nComponents: main\nArchitectures: amd64,arm64,armhf\nSigned-By: /usr/share/keyrings/microsoft.gpg" | sudo tee /etc/apt/sources.list.d/vscode.sources > /dev/null
	$UPDATE_CMD

	$INSTALL_CMD code

	# VS Code doesn't see /usr/share/fonts (where apt puts them) for some reason
	# So we need to install fonts to /usr/local/share/fonts
	echo "Installing fonts..."
	sudo wget -P /usr/local/share/fonts https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Regular.ttf
	sudo wget -P /usr/local/share/fonts https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold.ttf
	sudo wget -P /usr/local/share/fonts https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Italic.ttf
	sudo wget -P /usr/local/share/fonts https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold%20Italic.ttf
	# Update font cache
	fc-cache -fv
	info_end "Visual Studio Code installed"
}
export -f install_code

function install_dbeaver() {
	info_start "Installing DBeaver"

	sudo  wget -O /usr/share/keyrings/dbeaver.gpg.key https://dbeaver.io/debs/dbeaver.gpg.key
	echo "deb [signed-by=/usr/share/keyrings/dbeaver.gpg.key] https://dbeaver.io/debs/dbeaver-ce /" | sudo tee /etc/apt/sources.list.d/dbeaver.list
	$UPDATE_CMD

	$INSTALL_CMD dbeaver-ce
	info_end "DBeaver installed"
}
export -f install_dbeaver

function install_spotify() {
	info_start "Installing Spotify"
	curl -sS https://download.spotify.com/debian/pubkey_C85668DF69375001.gpg | sudo gpg --dearmor --yes -o /etc/apt/trusted.gpg.d/spotify.gpg
	echo "deb https://repository.spotify.com stable non-free" | sudo tee /etc/apt/sources.list.d/spotify.list
	$UPDATE_CMD

	$INSTALL_CMD spotify-client
	info_end "Spotify installed"
}
export -f install_spotify

function install_docker() {
	# https://docs.docker.com/engine/install/ubuntu/

	# Add Docker's official GPG key:
	$UPDATE_CMD
	$INSTALL_CMD ca-certificates curl
	sudo install -m 0755 -d /etc/apt/keyrings
	sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
	sudo chmod a+r /etc/apt/keyrings/docker.asc

	# Add the repository to Apt sources:
	echo \
	"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
	$(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
	sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
	$UPDATE_CMD

	# Install the latest version
	$INSTALL_CMD docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    # Add user to docker group
    sudo usermod -aG docker $USER
}
export -f install_docker
